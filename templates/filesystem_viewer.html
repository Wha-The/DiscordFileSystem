<head>
	<title>Secure File System - {{Quote}}</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="/src/srcs"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"
      lazyload
    />

	<style>
		.noSelect {
			 -moz-user-select: -moz-none;
			 -khtml-user-select: none;
			 -webkit-user-select: none;
			 -ms-user-select: none;
			 user-select: none;
		}
		.specialborders {
			outline: solid 5px #FC5185;
		}
		#overlay {
		  position: fixed;
		  display: none;
		  width: 100%;
		  height: 100%;
		  top: 0;
		  left: 0;
		  right: 0;
		  bottom: 0;
		  background-color: rgba(0,0,0,0.5);
		  z-index: 2;
		  cursor: pointer;
		}

		#overlay_text{
		  position: absolute;
		  top: 50%;
		  left: 50%;
		  font-family: Helvetica, Sans-Serif;
		  font-size: 50px;
		  color: white;
		  transform: translate(-50%,-50%);
		  -ms-transform: translate(-50%,-50%);
		}
		body {
			font-family: Helvetica, Sans-Serif;
		}
		.left_25 {
			position: absolute;
			left:25%;
		}
		.left_50 {
			position: absolute;
			left:50%;
		}
		.left_75 {
			position: absolute;
			left:75%;
		}
		.sticky {
		  position: fixed;
		  top: 0;
		  width: 100%
		}

		#actionbar{
			border-radius: 3px;
			z-index: 2;
		}
		.selected {
			background-color: #0059d1;
			color: white;
		}
		/*body {
			background-color: #212529;
			font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
			font-weight: 400;
		}
		h1, h2, h3, h4, h5, h6 {
		    margin-top: 0;
		    margin-bottom: 0.5rem;
		    font-weight: 500;
		    line-height: 1.2;
		    color: #fff;
		}*/
	</style>
	<style>
		.fjs-container {
		  background-color: white;
		  border: solid 1px lightgray;
		  display: flex;
		  font-size: .9em;
		  min-height: 400px;
		  overflow: auto;
		}

		.fjs-container:focus {
		  outline:none;
		}

		.fjs-col {
		  border-right: solid 1px lightgray;
		  max-height: 600px;
		  min-height: inherit;
		  min-width: 200px;
		  overflow-y: auto;
		}

		.fjs-item a {
		  align-items: flex-end;
		  color: black;
		  display: flex;
		  justify-content: space-between;
		  padding: 5px;
		  text-decoration: none;
		  cursor:pointer;
		}

		.fjs-item a:focus {
		  outline:none;
		}

		.fjs-item a span {
		  overflow: hidden;
		  text-overflow: ellipsis;
		  white-space: nowrap;
		}

		.fjs-item a span i {
		  padding-right: 5px;
		}

		.fjs-active a {
		  background-color: #DEDEDE;
		}

		.fjs-col:nth-last-child(2) .fjs-active a,
		.fjs-col:last-child .fjs-active a {
		  background-color: dodgerblue;
		  color: white;
		}

		.fjs-list {
		  list-style: none;
		  margin: 0;
		  padding: 0;
		}

		.fjs-item-content {
		  overflow: hidden;
		  text-overflow: ellipsis;
		  white-space: nowrap;
		}

		.fa-folder {
		  color: #90E4FF;
		}

		.fa-file-o {
		  color: #A7A7A7;
		}

		.fa-external-link {
		  color: #629EFF;
		  font-size: smaller;
		}

		.fa-caret-right {
		  color: gray;
		  padding: 0 0 0 .5em;
		}

		.fjs-col:nth-last-child(2) .fjs-active a .fa-caret-right,
		.fjs-col:last-child .fjs-active a .fa-caret-right {
		  color: white;
		}

		.leaf-col {
		  align-items: center;
		  border-right: 0;
		  display: flex;
		  flex: 2;
		  justify-content: center;
		  padding: 0 1.5em;
		}

		.leaf-row {
		  display: flex;
		  flex-direction: column;
		  font-size: 1.3em;
		  text-align: center;
		}

		.leaf-row .fa {
		  color: #A7A7A7;
		  font-size: 4em;
		  margin: 20px 0;
		}

		.leaf-row .fa-refresh {
		  font-size: 2em;
		}

		.leaf-col .meta {
		  font-size: .7em;
		}

		.leaf-col .meta strong {
		  color: #C1C1C1;
		  font-weight: normal;
		}

		.leaf-col .meta:first-of-type {
		  margin-top: 1.5em;
		}
		body {
			font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
		}
		.btn {
			border-radius: 0;
		}
		.fileUploadBars {
    	transition: height 0.15s ease-out;
		}
</style>
</head>
<body>
	<h1>Secure File System &ndash; {{Quote}}</h1><hr>
	<p id="errmsg" style="color:red;"></p>
	<h1 style="display:flex"><b id="drive"></b><b id="cwd"></b></h1>
	<hr>
	<div id="actionbar" class="btn-group">
		<button class="btn btn-secondary btn-lg" id="actionbar_refresh" disabled>Refresh</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_cd" disabled>CD</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_download" disabled>Download</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_edit" disabled>Quick Open</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_upload" disabled>Upload</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_newFolder" disabled>New Folder</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_rename" disabled>Rename</button>
		<button class="btn btn-secondary btn-lg" id="actionbar_delete" disabled>Delete</button>
	</div>
	<div id="files" class="fjs-container noselect">
		<div class="fjs-col">
			<ul class="fjs-list" id="files-list">

			</ul>
		</div>
	</div>
	<div id="fileUploadBars"></div>
	<hr>
	<br><br><br>
	<p>Current status: <b id="status"></b></p>
	<button type="button" onclick="connect()">Connect</button>
	<button type="button" onclick="disconnect()">Disconnect</button>
	<hr>
	<div id="settings">
		<h1>Settings</h1>
		<label><input type="checkbox" id="settings_autoconnect" onchange="save_settings()"> Automacticly connect</label><br>

	</div>
	<hr>	 
	<br><br><button onclick="window.location.href='/logout';">Logout</button>


	<input id="file-input" type="file" name="name" style="display: none;" multiple onchange="handleFiles(this.files)"/>
	<div id="overlay">
	  <div id="overlay_text">Drop files to upload to the CWD</div>
	</div>
	<script>
		JQueryNotLoadedHelp = "Please refresh your page or contact the server owner"
		$ = window.$||alert("JQuery was not properly loaded! "+JQueryNotLoadedHelp)
		ws = null;
		expectedstatus="disconnected"
		function disconnect(){
			expectedstatus = "disconnected"
			document.getElementById("status").innerHTML = "Disconnected"
			if (ws){
				ws.close()
				ws = null
			}
		}
		systemFilenames = [
			".."
		]
		SAVED_CWD = "/"
		Settings = [
			document.getElementById("settings_autoconnect"),
		]
		CURRENTSETTINGS = {}
		function save_settings(){
			ToBeSaved = {}
			for (i=0;i<Settings.length;i++){
				currentelem = Settings[i]
				ToBeSaved[currentelem.id] = currentelem.checked
			}
			CookieManager.setCookie("filesystem_settings",JSON.stringify(ToBeSaved), 1)
			CURRENTSETTINGS = ToBeSaved
			showsnack("Changes Saved",1000)
		}
		function load_settings(){
			Settings_raw = CookieManager.getCookie("filesystem_settings")
			if (Settings_raw!=""){
				Loaded_settings = JSON.parse(Settings_raw)
				CURRENTSETTINGS = Loaded_settings
				Object.keys(Loaded_settings).forEach(function(key){
					checked = Loaded_settings[key]
					if(checked!=null){
						document.getElementById(key).checked = checked
					}
				})

				return Loaded_settings
			}
			return {};
		}
		loadedfuncfinished = Scripts.runAfterLoaded("CookieManager", function(){
			var settings = load_settings()
			if(settings["settings_autoconnect"]){
				connect()
			}
		})
		function get_fname_icon_class(filename, isfolder){
			var dotslips = filename.split(".")
			var ext = !isfolder&&(dotslips[dotslips.length - 1]||"unknown")||"folder"
			var iconcode = "fa fa-file-o"
			var icons = {
				"folder":"fa fa-folder",
				"txt":"fa fa-file-text-o",
				"docx":"fa fa-file-word-o",
				"pdf":"fa fa-file-pdf-o",
				"pptx": "fa fa-file-powerpoint-o",

				"py": "fa fa-file-code-o",
				"html": "fa fa-file-code-o",
				"js": "fa fa-file-code-o",
				"css": "fa fa-file-code-o",

				"mp4":"fa fa-file-video-o",
				"mov":"fa fa-file-video-o",

				"png":"fa fa-file-image-o",
				"jpg":"fa fa-file-image-o",
				"jpeg":"fa fa-file-image-o",
				"gif":"fa fa-file-image-o",

				"zip": "fa fa-file-archive-o",
			}
			if (icons[ext.toLowerCase()]){
				iconcode = icons[ext.toLowerCase()]
			}
			return iconcode
		}
		function updateFilesList(files, drive, cwd){
			if(cwd!="/")files.unshift({"name":"..","isfile":false})
			document.getElementById("cwd").innerHTML = cwd
			document.getElementById("drive").innerHTML = drive+":"
			window.history.pushState("", "", '/filesystem'+cwd);
			SAVED_CWD = cwd
			div = document.getElementById("files-list")
			fileListData = ""
			for (i=0;i<files.length;i++){
				var current = files[i]
				var currentAdd = ""
				var iconcode = get_fname_icon_class(current.name, !current.isfile)
				
				if (current.protected){
					iconcode = "fa fa-lock"
				}
				allfilestring = []
				currentfileindex = 0
				if(current.filesinside){
					current.filesinside.forEach(function(file){
						if (currentfileindex == 3){
							allfilestring.push("...")
						}
						else if (currentfileindex>3){
							return
						}
						else{
							allfilestring.push(file)
						}
						currentfileindex = currentfileindex + 1
					})
				}
				// currentAdd = "<li isfile='"+((current.isfile&&2||1)-1)+"' filename='"+current.name+"' class='noSelect'>"+extcode+" <font id='filename'>"+current.name+"</font>"+(systemFilenames.includes(current.name)&&"<font class='left_25'>System Path</font>"||
				// `<font class="left_25">Size: `+current.size+`</font>
				// `+
				// (current.protected&&"<font class='left_50'>Hidden</font>"||(current.filesinside&&current.filesinside.length>0 && `<font class="left_50">Files: [`+current.filesinside.length+`] `+allfilestring.join("<b>, </b>")+"</font>"||"<font class='left_50'></font>"))
				// +"</p>"	

				// )
				currentAdd = `<li class='fjs-item ${!current.isfile && "fjs-has-children" || ""}' data-isfile='${((current.isfile&&2||1)-1)}' data-filename='${current.name}' data-last-modified='${current.lastmodified}' data-fsize='${current.size}' id='file_${current.name}'>
					<a tabindex="-1" ondblclick='doubleclick(event, this.parentElement)' onclick='select("${current.name}")'>
						<span>
							<i class="${iconcode}"></i>
							${current.name}
						</span>
						${!systemFilenames.includes(current.name) && !current.isfile && "<i class='fa fa-caret-right'></i>" ||""}
						${systemFilenames.includes(current.name) && "<i class='fa fa-caret-left'></i>" ||""}
					</a>
				</li>`

				fileListData = fileListData +"\n"+currentAdd
			}
			div.innerHTML = fileListData
		}
		function link_enter_button(target,callback){
			target.addEventListener("keyup", function(event) {
				value = target.value
				event.preventDefault();
			  setTimeout(function(){
				  if (event.keyCode === 13) {
				    callback(value);
				  }
				 },25)
			});
		}
	function gobacktopath(p){
		console.log("GOING BACK TO PATH: ",p)
		let inner = function(fcall){
			setTimeout(() => {
				if (SAVED_CWD != p)return inner(fcall)
				return fcall()
			}, 200)
			cd("..")
		}
		return new Promise((resolve, reject) => {
			inner(resolve)
		})
	}
	async function gotopath(path){
			if(typeof path == "string") path = path.split(/\//g)
			var cwd_path = SAVED_CWD.split(/\//g)
			var goBackToPath = [""]
			cwd_path.forEach((seg, index) => {
				if(path[index] != seg){
					goBackToPath = path.slice(0, index-1)
				}
			})
			goBackToPath = "/" + goBackToPath.join("/")
			await gobacktopath(goBackToPath)
			path.forEach(function(segment){
				
				if(segment){
					console.log(segment)
					cd(segment)
				}
			})
		}
		REFRESH_AFTERFUNC = null
		function _connect(reconnection){
			if (reconnection){
				console.log("reconnection")
			}
			document.getElementById("status").innerHTML = "Connecting..."
			ws = {}
			try{
				wss = new WebSocket("ws"+(window.location.protocol=="https:"&&"s"||"")+"://"+location.host+"/api/websocket");
			}
			catch(e){
				ws = null
				document.getElementById("errmsg").innerHTML = "Connection attempt failed!"
				return
			}

			wss.onopen = function() {
				document.getElementById("status").innerHTML = "Connected"
				expectedstatus = "live"
				gotopath(decodeURIComponent(location.pathname).split(/\//g).slice(2))
			};
			var sounds = {
				click:new Audio('/resource?filename=click.mp3'),
				error:new Audio('/resource?filename=error.mp3'),
			}
			ws.onmessage = function (evt) {
				document.getElementById("status").innerHTML = "Connected"
				response = JSON.parse(evt.data)
				error = response.error
				redirect = response.redirect
				console.log(response)
				if (error){
					document.getElementById("errmsg").innerHTML = error
				}
				else if (redirect){
					window.location.href = redirect
				}
				else{
					content = response.content
					previousAction = response.action
					if (previousAction == "cd"){
						if (response.passwordRequired){
							if(response.passwordIncorrect)alert("Incorrect password")
							// document.getElementById("overlay_text").innerHTML = `
							// Password Required: Please enter the password to this directory.
							// <br>
							// <input type="password" id='cd_password_input' placeholder="password" autocomplete="off" autocorrect="off" autocapitalize="off"><br>
							// <button onclick="document.getElementById('overlay').style.display = 'none';">Close</button>
							// <button onclick='cd("`+response.cd+`",document.getElementById("cd_password_input").value)' id="cd_password_input_button">CD</button>
							// `
							// input = document.getElementById("cd_password_input")
							// link_enter_button(input,function(value){	
							// 	cd(response.cd,value)
							// })
							// document.getElementById("overlay").style.display = "block"
							// input.focus()
							var value = prompt("Password Required: Enter password for "+(SAVED_CWD+response.cd))
							if(value)cd(response.cd, value)
						}
						else{
							sounds.click.play();
							document.getElementById('overlay').style.display = 'none';
							ws.send(JSON.stringify({"action":"getCDContents"}))
						}
					}
					if (previousAction == "getCDContents"){

						updateFilesList(response.files, response.drive, response.cwd)
						if (response.afterselect){
							SELECTED = response.afterselect
						}
						else{
							SELECTED = null
						}
						update()
						if(REFRESH_AFTERFUNC){
							REFRESH_AFTERFUNC()
							REFRESH_AFTERFUNC=null
						}
					}
					if (previousAction == "delFile"){
						refreshDirectory()
						SELECTED = null
						update()
					}
					if (previousAction == "downloadFile"){
						console.log(response.progress)
						monitorFileProgress(response.filename, response.progress, onconnect=() => {
							var iframe = document.createElement("iframe")
							iframe.src = response.url
							iframe.style.display = "none"
							document.body.appendChild(iframe)
						})
					}
					if (previousAction == "newFolder"){
						if (response.afterselect){
							afselect = response.afterselect
							refreshDirectory(null,function(){
								select(afselect)
								rename(afselect)
							})
						}
					}
				}
			}

			wss.onclose = function(){
				document.getElementById("status").innerHTML = "Disconnected"
				if (expectedstatus!="disconnected"){
					connect(true)
				}
			}
			wss.onmessage = function(evt){
				(async() => {
				    while(!window.hasOwnProperty("ENCRYPTION_READY"))
				        await new Promise(resolve => setTimeout(resolve, 10));
				    ws.onmessage({
						"data": window.client_decrypt(evt.data),
					})
				})();
			}
			ws.send = function(data){
				(async() => {
				    while(!window.hasOwnProperty("ENCRYPTION_READY"))
				        await new Promise(resolve => setTimeout(resolve, 10));
				    wss.send(window.client_encrypt(data))
				})();
			}
			ws.close = () => wss.close
		};
		function connect(reconnection){
			(async() => {
			    while(!window.hasOwnProperty("ENCRYPTION_READY"))
			        await new Promise(resolve => setTimeout(resolve, 10));
			    _connect(reconnection)
			})();
		}
		SELECTED = null
		function pingws(noalert){
			if (!ws){
				if (!noalert)alert("Please connect to the server.")
				return false
			}
			return true
		}
		
		
		function cd(dir,password){
			if (!pingws())return
			try{
				if (!popup.closed){alert("Popup window still open. Close it to change directory");return}
			}
			catch(e){

			}
			
			dir = dir||SELECTED
			if(dir){
				data = JSON.stringify({"action":"cd","data":{"dir":dir,"password":password}})
				console.log("CD SEND DATA: "+data)
				ws.send(data)
			}
		}
		function download(){
			if (!pingws())return
			if(SELECTED)ws.send(JSON.stringify({"action":"downloadFile","data":{"file":SELECTED}}))
		}
		function upload(){
			document.getElementById("file-input").click()
		}
		function rename(file){
			elem = document.getElementById("file_"+file)
			origInnerHtml = elem.innerHTML
			elem.innerHTML = "<input type='text' id='rename_"+file+"' value='"+elem.getAttribute("data-filename")+"' placeholder='new name' style='width:100%;max-width:100%'>"
			renameelem = document.getElementById("rename_"+file)
			renameelem.select()
			renameelem.addEventListener("keyup", function(event) {
				event.preventDefault();
					// Number 13 is the "Enter" key on the keyboard
					setTimeout(function(){
						if (event.keyCode === 13) {
							// Cancel the default action, if needed
							
							after = renameelem.value
							ws.send(JSON.stringify({action:"renFile",data:{from:file,to:after}}))
							refreshDirectory(after)

						}
						if (event.keyCode === 27){ // esc
							elem.innerHTML = origInnerHtml
						}
					},25)
				});
		}
		function editAddressBar(){
			if(document.getElementById("edit_cwd"))return
			elem = document.getElementById("cwd")
			origInnerHtml = elem.innerHTML
			elem.innerHTML = "<input type='text' id='edit_cwd' value='"+elem.innerHTML+"' placeholder='new name' style='flex-grow:1; font-size:1em;'>"

			renameelem = document.getElementById("edit_cwd")
			renameelem.select()
			renameelem.onblur = () => {
				elem.innerHTML = origInnerHtml
			}
			renameelem.addEventListener("keyup", function(event) {
				event.preventDefault();
					// Number 13 is the "Enter" key on the keyboard
					setTimeout(function(){
						if (event.keyCode === 13) {
							// Cancel the default action, if needed
							after = renameelem.value
							renameelem.onblur = () => {}
							gotopath(after)
						}
						if (event.keyCode === 27){ // esc
							elem.innerHTML = origInnerHtml
						}
					},25)
				});
		}
		recentdoubleclick = false
		function select(file){
			setTimeout(function(){
				if (!pingws())return
				if (recentdoubleclick){
					recentdoubleclick=false
					return
				}
				if (SELECTED == file){
					if (systemFilenames.includes(file)){
						return
					}

				}
				else{
					SELECTED = file
					update()
				}
			},10)
		}
		function getFileDownloadLink(fname, finish, view){
			if (!pingws())return
			var OLDWSONMESSAGEHANDLER = ws.onmessage
			var retrievedData = null
			ws.onmessage = function(data){
				response = JSON.parse(data.data)
				if (response.url){
					ws.onmessage = OLDWSONMESSAGEHANDLER
					monitorFileProgress(response.filename, response.progress)
					finish(response.url)
				}
			}
			ws.send(JSON.stringify({"action": (view ? "view" : "download")+"File","data":{"file":fname}}))
		}
		function getFileContents(fname,finish){
			if (!pingws())return
			getFileDownloadLink(fname, function(redirect){
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function(){
				    if (this.readyState == 4 && this.status == 200){
				        var url = window.URL || window.webkitURL;
				        var a = new FileReader();
						a.onload = function(e) {finish(e.target.result);}
						a.readAsDataURL(this.response);
				        
				    }
				}
				xhr.open('GET', redirect);
				xhr.responseType = 'blob';
				xhr.send();  
			})
			
		}
		var edit_callbacks = {
			".txt": edittxt,
			
			".mp4": editmp4,
			".mov": editmp4,

			".png": editpng,
			".jpg": editpng,
			".jpeg": editpng,
			".gif": editpng,
		}
		function edit(evt){
			if(evt.ctrlKey){
				getFileDownloadLink(SELECTED, window.open, true)
				return
			}
			var s = SELECTED.toLowerCase()
			Object.entries(edit_callbacks).forEach(x => {
				var suffix = x[0], callback = x[1]
				if(s.endsWith(suffix))callback()
			})
		}
		function editpng(){
				
				getFileDownloadLink(SELECTED, function(url){
					popup = window.open(" ","Image Viewer","width=600,height=500,location=no")
					writedata = `
	<title>Image Viewer</title>
	<img src="`+url+`" width=100% height=100% style="object-fit: cover;">
					`
					popup.$ = $
					popup.document.write(writedata)
				})
					
			}	
		function editmp4(){
			
			getFileDownloadLink(SELECTED, function(url){
				popup = window.open(" ","Video Player","width=1000,height=500,location=no")
				writedata = `
<title>Video Player</title>
<video controls width="100%" height="100%" id="player">

    <source src="`+url+`"
            type="video/mp4">

    Sorry, your browser doesn't support embedded videos.
</video>
				`
				popup.$ = $
				popup.document.write(writedata)
				var v = popup.document.getElementById("player");
				v.addEventListener( "loadedmetadata", function (e) {
				    var width = this.videoWidth,
				        height = this.videoHeight;
				    popup.resizeTo(width, height)
				}, false );
			})
				
		}

		function edittxt(){
			var currentFName = SELECTED
			getFileContents(SELECTED,function(data){
				popup = window.open("","Editor","width=500,height=500,location=no")
				writedata = `
<title>Editor</title>
<style>
#snackbar {
  visibility: hidden;
  min-width: 250px;
  margin-left: -125px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 25px;
  padding: 16px;
  position: fixed;
  z-index: 1;
  left: 50%;
  bottom: 30px;
  font-size: 17px;
  font-family: Helvetica, Sans-Serif;
}

#snackbar.show {
  visibility: visible;
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

</style>
<textarea style="width:100%;height:90%" id="editor">
`+data+`
</textarea>
<div id="snackbar">Some text some message..</div>
<sc`+`ript>
saved = true
keydown = function(event) {
    if (event.ctrlKey || event.metaKey) {
        switch (String.fromCharCode(event.which).toLowerCase()) {
        case 's':
            event.preventDefault();
            save()
            break;
        case 'f':
            event.preventDefault();
            alert('ctrl-f');
            break;
        case 'g':
            event.preventDefault();
            alert('ctrl-g');
            break;
        }
    }
}
$(window).bind('keydown', keydown);
$("#editor").bind('keydown', keydown);
document.getElementById("editor").oninput = function(){
	saved = false
}

function showsnack(text,timeout) {
  var x = document.getElementById("snackbar");
  x.className = "show";
  x.innerHTML = text||x.innerHTML
  close = function(){ x.className = x.className.replace("show", ""); }
  if(timeout!=false){
  	return setTimeout(close, timeout||3000);
  }
  return close


}

</sc`+`ript>
				`
				popup.$ = $
				popup.document.write(writedata)
				popup.addEventListener('beforeunload', function (e) {
					if (!popup.saved){
					  e.preventDefault();
					  e.returnValue = 'Changes will not be saved';
					}
					});


				popup.save = function(){
					var data = popup.document.getElementById("editor").value
					var file = new File([data], currentFName, {
					    lastModified: new Date(0),
					    type: "overide/mimetype"
					});
					var finishedUploading = []
					async function uploadSingleFile(file,done){
						console.log(file)
						
						let formData = new FormData();    
						     
						formData.append("file", file);
						formData.append("data", JSON.stringify({"path":SAVED_CWD, "last_modified":file.lastModified / 1000}));  

						try {
						   let r = await fetch('/api/upload', {method: "POST", body: formData}); 
						   console.log('HTTP response code:',r.status); 
						   done()
						} catch(e) {
						   console.log('Huston we have problem...:', e);
						   uploadSingleFile(file, done)
						}
					}
					uploadSingleFile(file,function(){
						refreshDirectory(currentFName)
						popup.showsnack("Saved Sucessfully")
						popup.saved = true
					})
				}
			})

		}
		
		function doubleclick(evt,elem){
			evt.preventDefault()
			if (!pingws())return
			recentdoubleclick = true
			fname = elem.getAttribute("data-filename")
			isfile = elem.getAttribute("data-isfile")=="1"
			if (isfile){
				edit(fname)
			}
			else{
				cd(fname)
			}
		}
		(()=>{
			var doeditaddrbar = function(evt){
				evt.preventDefault()
				if(!pingws())return
				editAddressBar()
			}
			document.getElementById("cwd").onclick = doeditaddrbar
			document.getElementById("drive").onclick = doeditaddrbar
		})()
		
		function createLeafRow(fname, fsize, iconhtml, lastModified){
			var div = document.createElement("div")
			/* <div class="fjs-col leaf-col"><div class="leaf-row"><i class="fa fa-file-o"></i>.codeclimate.yml<div class="meta"><strong>Size: </strong>56 KB</div><div class="meta"><strong>Modified: </strong>02/21/2015 at 10:04am</div></div></div> */
			div.classList = "fjs-col leaf-col"
			div.id = "leafrow"
			var timeString = "???"
			if (lastModified != 0){
				var lastModifiedDate = new Date(lastModified * 1000)
				var timeString = `${String(lastModifiedDate.getDate()).padStart(2, '0')}/${String(lastModifiedDate.getMonth()).padStart(2, '0')}/${String(1900 + lastModifiedDate.getYear()).padStart(4, '0')} at ${String(lastModifiedDate.getHours() % 12).padStart(2, '0')}:${String(lastModifiedDate.getMinutes()).padStart(2, '0')}${lastModifiedDate.getHours() >= 12 ? 'pm' : 'am'}`
			}

			div.innerHTML = `<div class="leaf-row">
				${iconhtml}
				${fname}
				<div class="meta">
					<strong>Size: </strong>${humanFileSize(fsize, si=true)}
				</div>
				<div class="meta">
					<strong>Modified: </strong>${timeString}
				</div>
			</div>`
			document.getElementById("files").appendChild(div)
			return div
		}
		function update(){
			if (!pingws())return
			elems = document.getElementById("files-list").children
			for (i=0;i<elems.length;i++){
				elem = elems[i]
				if(elem.classList.contains("fjs-active")){
					elem.classList.remove("fjs-active")
				}
			}
			actionbar_refersh = true
			actionbar_cd = false
			actionbar_download = false
			actionbar_edit = false
			actionbar_upload = true
			actionbar_newFolder = true
			actionbar_rename = false
			actionbar_delete = false
			var leafRow = document.getElementById("leafrow")
			if(leafRow) leafRow.parentElement.removeChild(leafRow)
			if (SELECTED){
				elem = document.getElementById("file_"+SELECTED)
				leafRow = createLeafRow(SELECTED, elem.getAttribute("data-fsize"), elem.querySelector("i").outerHTML, elem.getAttribute("data-last-modified"))
				isfile = elem.getAttribute("data-isfile")=="1"
				elem.classList.add("fjs-active")
				actionbar_download = true
				actionbar_delete = true
				actionbar_rename = true
				if (isfile){
					var canEdit = false;
					Object.entries(edit_callbacks).forEach(x => {
						var suffix = x[0]
						if(SELECTED.toLowerCase().endsWith(suffix)){
							canEdit = true
						}
					})
					if(canEdit){
						actionbar_edit = true
					}
				}	
				else{
					actionbar_cd = true
				}
			}
			if (systemFilenames.includes(SELECTED)){
				actionbar_delete = false
				actionbar_download = false
			}
			document.getElementById("actionbar_refresh")[actionbar_refersh&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_cd")[actionbar_cd&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_download")[actionbar_download&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_edit")[actionbar_edit&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_upload")[actionbar_upload&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_newFolder")[actionbar_newFolder&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_rename")[actionbar_rename&&"removeAttribute"||"setAttribute"]("disabled",true)
			document.getElementById("actionbar_delete")[actionbar_delete&&"removeAttribute"||"setAttribute"]("disabled",true)
		}
		function refreshDirectory(afterselect,afterfunc){
			if(afterfunc)REFRESH_AFTERFUNC = afterfunc
			if (!pingws())return
			ws.send(JSON.stringify({"action":"getCDContents",data: {afterselect:afterselect}}))
		}
		window.refreshDirectory = refreshDirectory
	
	document.getElementById("actionbar_refresh").onclick = ()=> refreshDirectory()
	document.getElementById("actionbar_cd").onclick = function(){cd()}
	document.getElementById("actionbar_download").onclick = download;
	document.getElementById("actionbar_edit").onclick = edit;
	document.getElementById("actionbar_upload").onclick = upload;
	document.getElementById("actionbar_newFolder").onclick = function(){
		if(!pingws())return
		ws.send(JSON.stringify({"action":"newFolder"}))
	}
	document.getElementById("actionbar_delete").onclick = function(){
		if (confirm(`Are you sure you want to delete "${document.getElementById("file_"+SELECTED).getAttribute("data-filename")}"?`)){
			ws.send(JSON.stringify({action:"delFile",data:{file:SELECTED}}))
		}
	}

	document.getElementById("actionbar_rename").onclick = function(){
		rename(SELECTED)
	}
	// upload monitoring
	function monitorFileProgress(fname, pid, onconnect=undefined){
		var div = document.createElement("div")
		div.innerHTML = `<li class="fjs-item"><i class="${get_fname_icon_class(fname)}"></i>${fname}</li><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar"></div></div>`
		div.className = "fjs-list"
		div.children[1].children[0].innerHTML = "0%"
		div.children[1].children[0].style.width = "0%"
		document.getElementById("fileUploadBars").appendChild(div)

		// pid: progress id
		var wss = new WebSocket("ws"+(window.location.protocol=="https:"&&"s"||"")+"://"+location.host+"/api/file_progress_websocket");
		
		// wrappers
		var ws = {}
		wss.onmessage = (d) => ws.onmessage(window.client_decrypt(d.data)) // wrapper
		ws.send = (data) => wss.send(window.client_encrypt(data)) // wrapper

		wss.onopen = () => {
			ws.send(JSON.stringify({action:"ListenFileProgress", data: {progressid: pid}}))
			if(onconnect)onconnect()
		}
		ws.onmessage = (data) => {
			data = JSON.parse(data)
			if(data.progress){
				div.children[1].children[0].innerHTML = Math.round((data.progress*100))+"%"
				div.children[1].children[0].style.width = (data.progress*100)+"%"
			}
			if (data.completed){
				div.children[1].children[0].classList.remove("bg-primary")
				div.children[1].children[0].classList.add("bg-success")
				wss.close()
				refreshDirectory(fname)
				setTimeout(() => div.parentElement.removeChild(div), 5000)
			}
		}


	}
	// uploading
	fileinput = document.getElementById("file-input");
	fileinput.addEventListener("change", handleFiles, false);
	toBase64 = file => new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = () => resolve(reader.result);
			reader.onerror = error => reject(error);
	});
	function getFileBase64(file,done){
		 const result = toBase64(file).then(res => done(res.split(",")[1])).catch(e => Error(e));
		 if(result instanceof Error) {
				console.log('Error: ', result.message);
				return;
		 }
		 
	}
	function handleFiles(files) {
		finishedUploading = []
		async function uploadSingleFile(file,i, attemptNumber){
			attemptNumber=attemptNumber||0
			if(file.size >= (10485760000)){
				alert("Unable to upload "+file.name+":\nFile exceeds 10GB.")
			   	finishedUploading[i] = true
			   	return
			}
			
			let formData = new FormData();    
			     
			formData.append("file", file);
			formData.append("data", JSON.stringify({"path":SAVED_CWD, "last_modified":file.lastModified / 1000}));  

			try {
			   fetch('/api/upload', {method: "POST", body: formData}).then(function(r){
			   	r.json().then((data) => {
			   		if(data.success && data.progress){
			   			monitorFileProgress(file.name, data.progress)
			   		}
			   	})
			   	console.log('HTTP response code:',r.status); 
			   	finishedUploading[i] = true
			   }); 
			   
			} catch(e) {
			   console.log('Huston we have problem...:', e);
			   if (attemptNumber >= 3){
			   	alert("Unable to upload "+file.name+":\n"+e)
			   	finishedUploading[i] = true
			   }
			   else{
			   	uploadSingleFile(file, i, attemptNumber + 1)
			   }
			}
		}

		for (var i=0;i<files.length;i++){
			file = files[i]
			finishedUploading[i] = false
			uploadSingleFile(file,i)
		}
		i = setInterval(function(){
			if(finishedUploading.every((item) => item)){
				console.log("done")
				clearInterval(i)
			}
		},100)
	}
	var dragTimer;
	function drop(e) {
		dropbox.classList.remove("specialborders")
		document.getElementById("overlay").style.display = "none";
		if(!pingws())return
		const dt = e.originalEvent.dataTransfer;
		const files = dt.files;

		handleFiles(files);
	}
	dropbox = document.body
	var dragTimer;
	$(dropbox).on("dragenter dragstart dragend dragleave dragover drag drop", function (e) {
			e.preventDefault();
	});
	$(dropbox).on('dragover', function(e) {
		var dt = e.originalEvent.dataTransfer;
		if (dt.types && (dt.types.indexOf ? dt.types.indexOf('Files') != -1 : dt.types.contains('Files'))) {
			dropbox.classList.add("specialborders")
			document.getElementById("overlay").style.display = "block";
			document.getElementById("overlay_text").innerHTML = pingws(true)?"Drop files to upload":"Please connect to the server first"
			window.clearTimeout(dragTimer);
		}
	});
	$(dropbox).on('dragleave', function(e) {
		dragTimer = window.setTimeout(function() {
			dropbox.classList.remove("specialborders")
			document.getElementById("overlay").style.display = "none";
		}, 25);
	});

	$(dropbox).on("drop",drop)


document.body.addEventListener("click", function(e) {
    var elem = e.target;
    if (Array.from(document.querySelectorAll(".fjs-col")).includes(elem)){
    	SELECTED = null
		update()
    }
});

	</script>
</body>
